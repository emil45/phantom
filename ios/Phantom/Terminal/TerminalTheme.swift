import SwiftTerm
import UIKit

/// Terminal color theme with ANSI palette and persistence.
struct TerminalTheme: Identifiable {
    let id: String
    let name: String
    let background: UIColor
    let foreground: UIColor
    let cursor: UIColor
    let selection: UIColor
    let isDark: Bool
    let ansiColors: [SwiftTerm.Color]?

    private static let key = "phantom.terminal.themeId"

    static var saved: TerminalTheme {
        let id = UserDefaults.standard.string(forKey: key) ?? "nord"
        return allThemes.first { $0.id == id } ?? nord
    }

    static func save(_ theme: TerminalTheme) {
        UserDefaults.standard.set(theme.id, forKey: key)
    }

    // MARK: - Built-in Themes

    static let allThemes: [TerminalTheme] = [
        nord, oneDark, dracula, solarizedDark,
        tokyoNight, catppuccinMocha, gruvboxDark,
        kanagawaWave, kanagawaDragon,
        flexokiDark, flexokiLight,
    ]

    // MARK: - Dark Themes

    static let nord = TerminalTheme(
        id: "nord",
        name: "Nord",
        background: UIColor(red: 0x2E, green: 0x34, blue: 0x40),
        foreground: UIColor(red: 0xD8, green: 0xDE, blue: 0xE9),
        cursor: UIColor(red: 0x88, green: 0xC0, blue: 0xD0),
        selection: UIColor(red: 0x43, green: 0x4C, blue: 0x5E),
        isDark: true,
        ansiColors: ansi(
            (0x3B, 0x42, 0x52), (0xBF, 0x61, 0x6A), (0xA3, 0xBE, 0x8C), (0xEB, 0xCB, 0x8B),
            (0x81, 0xA1, 0xC1), (0xB4, 0x8E, 0xAD), (0x88, 0xC0, 0xD0), (0xE5, 0xE9, 0xF0),
            (0x4C, 0x56, 0x6A), (0xBF, 0x61, 0x6A), (0xA3, 0xBE, 0x8C), (0xEB, 0xCB, 0x8B),
            (0x81, 0xA1, 0xC1), (0xB4, 0x8E, 0xAD), (0x8F, 0xBC, 0xBB), (0xEC, 0xEF, 0xF4)
        )
    )

    static let oneDark = TerminalTheme(
        id: "one-dark",
        name: "One Dark",
        background: UIColor(red: 0x28, green: 0x2C, blue: 0x34),
        foreground: UIColor(red: 0xAB, green: 0xB2, blue: 0xBF),
        cursor: UIColor(red: 0x52, green: 0x8B, blue: 0xFF),
        selection: UIColor(red: 0x3E, green: 0x44, blue: 0x51),
        isDark: true,
        ansiColors: ansi(
            (0x3F, 0x44, 0x51), (0xE0, 0x6C, 0x75), (0x98, 0xC3, 0x79), (0xE5, 0xC0, 0x7B),
            (0x61, 0xAF, 0xEF), (0xC6, 0x78, 0xDD), (0x56, 0xB6, 0xC2), (0xAB, 0xB2, 0xBF),
            (0x5C, 0x63, 0x70), (0xE0, 0x6C, 0x75), (0x98, 0xC3, 0x79), (0xE5, 0xC0, 0x7B),
            (0x61, 0xAF, 0xEF), (0xC6, 0x78, 0xDD), (0x56, 0xB6, 0xC2), (0xFF, 0xFF, 0xFF)
        )
    )

    static let dracula = TerminalTheme(
        id: "dracula",
        name: "Dracula",
        background: UIColor(red: 0x28, green: 0x2A, blue: 0x36),
        foreground: UIColor(red: 0xF8, green: 0xF8, blue: 0xF2),
        cursor: UIColor(red: 0xF8, green: 0xF8, blue: 0xF2),
        selection: UIColor(red: 0x44, green: 0x47, blue: 0x5A),
        isDark: true,
        ansiColors: ansi(
            (0x21, 0x22, 0x2C), (0xFF, 0x55, 0x55), (0x50, 0xFA, 0x7B), (0xF1, 0xFA, 0x8C),
            (0xBD, 0x93, 0xF9), (0xFF, 0x79, 0xC6), (0x8B, 0xE9, 0xFD), (0xF8, 0xF8, 0xF2),
            (0x62, 0x72, 0xA4), (0xFF, 0x6E, 0x6E), (0x69, 0xFF, 0x94), (0xFF, 0xFF, 0xA5),
            (0xD6, 0xAC, 0xFF), (0xFF, 0x92, 0xDF), (0xA4, 0xFF, 0xFF), (0xFF, 0xFF, 0xFF)
        )
    )

    static let solarizedDark = TerminalTheme(
        id: "solarized-dark",
        name: "Solarized Dark",
        background: UIColor(red: 0x00, green: 0x2B, blue: 0x36),
        foreground: UIColor(red: 0x83, green: 0x94, blue: 0x96),
        cursor: UIColor(red: 0x83, green: 0x94, blue: 0x96),
        selection: UIColor(red: 0x07, green: 0x36, blue: 0x42),
        isDark: true,
        ansiColors: ansi(
            (0x07, 0x36, 0x42), (0xDC, 0x32, 0x2F), (0x85, 0x99, 0x00), (0xB5, 0x89, 0x00),
            (0x26, 0x8B, 0xD2), (0xD3, 0x36, 0x82), (0x2A, 0xA1, 0x98), (0xEE, 0xE8, 0xD5),
            (0x00, 0x2B, 0x36), (0xCB, 0x4B, 0x16), (0x58, 0x6E, 0x75), (0x65, 0x7B, 0x83),
            (0x83, 0x94, 0x96), (0x6C, 0x71, 0xC4), (0x93, 0xA1, 0xA1), (0xFD, 0xF6, 0xE3)
        )
    )

    static let tokyoNight = TerminalTheme(
        id: "tokyo-night",
        name: "Tokyo Night",
        background: UIColor(red: 0x1A, green: 0x1B, blue: 0x26),
        foreground: UIColor(red: 0xA9, green: 0xB1, blue: 0xD6),
        cursor: UIColor(red: 0x7A, green: 0xA2, blue: 0xF7),
        selection: UIColor(red: 0x28, green: 0x2D, blue: 0x42),
        isDark: true,
        ansiColors: ansi(
            (0x15, 0x16, 0x1E), (0xF7, 0x76, 0x8E), (0x9E, 0xCE, 0x6A), (0xE0, 0xAF, 0x68),
            (0x7A, 0xA2, 0xF7), (0xBB, 0x9A, 0xF7), (0x7D, 0xCF, 0xFF), (0xA9, 0xB1, 0xD6),
            (0x41, 0x44, 0x68), (0xF7, 0x76, 0x8E), (0x9E, 0xCE, 0x6A), (0xE0, 0xAF, 0x68),
            (0x7A, 0xA2, 0xF7), (0xBB, 0x9A, 0xF7), (0x7D, 0xCF, 0xFF), (0xC0, 0xCA, 0xF5)
        )
    )

    static let catppuccinMocha = TerminalTheme(
        id: "catppuccin-mocha",
        name: "Catppuccin Mocha",
        background: UIColor(red: 0x1E, green: 0x1E, blue: 0x2E),
        foreground: UIColor(red: 0xCD, green: 0xD6, blue: 0xF4),
        cursor: UIColor(red: 0xF5, green: 0xE0, blue: 0xDC),
        selection: UIColor(red: 0x31, green: 0x32, blue: 0x44),
        isDark: true,
        ansiColors: ansi(
            (0x45, 0x47, 0x5A), (0xF3, 0x8B, 0xA8), (0xA6, 0xE3, 0xA1), (0xF9, 0xE2, 0xAF),
            (0x89, 0xB4, 0xFA), (0xCB, 0xA6, 0xF7), (0x94, 0xE2, 0xD5), (0xBA, 0xC2, 0xDE),
            (0x58, 0x5B, 0x70), (0xF3, 0x8B, 0xA8), (0xA6, 0xE3, 0xA1), (0xF9, 0xE2, 0xAF),
            (0x89, 0xB4, 0xFA), (0xCB, 0xA6, 0xF7), (0x94, 0xE2, 0xD5), (0xA6, 0xAD, 0xC8)
        )
    )

    static let gruvboxDark = TerminalTheme(
        id: "gruvbox-dark",
        name: "Gruvbox Dark",
        background: UIColor(red: 0x28, green: 0x28, blue: 0x28),
        foreground: UIColor(red: 0xEB, green: 0xDB, blue: 0xB2),
        cursor: UIColor(red: 0xFE, green: 0x80, blue: 0x19),
        selection: UIColor(red: 0x3C, green: 0x38, blue: 0x36),
        isDark: true,
        ansiColors: ansi(
            (0x28, 0x28, 0x28), (0xCC, 0x24, 0x1D), (0x98, 0x97, 0x1A), (0xD7, 0x99, 0x21),
            (0x45, 0x85, 0x88), (0xB1, 0x62, 0x86), (0x68, 0x9D, 0x6A), (0xA8, 0x99, 0x84),
            (0x92, 0x83, 0x74), (0xFB, 0x49, 0x34), (0xB8, 0xBB, 0x26), (0xFA, 0xBD, 0x2F),
            (0x83, 0xA5, 0x98), (0xD3, 0x86, 0x9B), (0x8E, 0xC0, 0x7C), (0xEB, 0xDB, 0xB2)
        )
    )

    static let kanagawaWave = TerminalTheme(
        id: "kanagawa-wave",
        name: "Kanagawa Wave",
        background: UIColor(red: 0x1F, green: 0x1F, blue: 0x28),
        foreground: UIColor(red: 0xDC, green: 0xD7, blue: 0xBA),
        cursor: UIColor(red: 0xC8, green: 0xC0, blue: 0x93),
        selection: UIColor(red: 0x2D, green: 0x4F, blue: 0x67),
        isDark: true,
        ansiColors: ansi(
            (0x09, 0x09, 0x0F), (0xC3, 0x40, 0x43), (0x76, 0x94, 0x6A), (0xC0, 0xA3, 0x6E),
            (0x7E, 0x9C, 0xD8), (0x95, 0x7F, 0xB8), (0x6A, 0x95, 0x89), (0xC8, 0xC0, 0x93),
            (0x72, 0x71, 0x69), (0xE8, 0x24, 0x24), (0x98, 0xBB, 0x6C), (0xE6, 0xC3, 0x84),
            (0x7F, 0xB4, 0xCA), (0x93, 0x8A, 0xA9), (0x7A, 0xA8, 0x9F), (0xDC, 0xD7, 0xBA)
        )
    )

    static let kanagawaDragon = TerminalTheme(
        id: "kanagawa-dragon",
        name: "Kanagawa Dragon",
        background: UIColor(red: 0x18, green: 0x16, blue: 0x16),
        foreground: UIColor(red: 0xC5, green: 0xC9, blue: 0xC5),
        cursor: UIColor(red: 0xC8, green: 0xC0, blue: 0x93),
        selection: UIColor(red: 0x2D, green: 0x4F, blue: 0x67),
        isDark: true,
        ansiColors: ansi(
            (0x0D, 0x0C, 0x0C), (0xC4, 0x74, 0x6E), (0x8A, 0x9A, 0x7B), (0xC4, 0xB2, 0x8A),
            (0x8B, 0xA4, 0xB0), (0xA2, 0x92, 0xA3), (0x8E, 0xA4, 0xA2), (0xC8, 0xC0, 0x93),
            (0xA6, 0xA6, 0x9C), (0xE4, 0x69, 0x76), (0x87, 0xA9, 0x87), (0xE6, 0xC3, 0x84),
            (0x7F, 0xB4, 0xCA), (0x93, 0x8A, 0xA9), (0x7A, 0xA8, 0x80), (0xC5, 0xC9, 0xC5)
        )
    )

    // MARK: - Light Themes

    static let flexokiDark = TerminalTheme(
        id: "flexoki-dark",
        name: "Flexoki Dark",
        background: UIColor(red: 0x10, green: 0x0F, blue: 0x0F),
        foreground: UIColor(red: 0xCE, green: 0xCE, blue: 0xC0),
        cursor: UIColor(red: 0xCE, green: 0xCE, blue: 0xC0),
        selection: UIColor(red: 0x28, green: 0x28, blue: 0x26),
        isDark: true,
        ansiColors: ansi(
            (0x28, 0x28, 0x26), (0xD1, 0x4D, 0x41), (0x87, 0x9A, 0x39), (0xD0, 0xA2, 0x15),
            (0x4B, 0x85, 0xD1), (0xCE, 0x5D, 0x97), (0x3A, 0xA9, 0x9F), (0xCE, 0xCE, 0xC0),
            (0x57, 0x57, 0x53), (0xD1, 0x4D, 0x41), (0x87, 0x9A, 0x39), (0xD0, 0xA2, 0x15),
            (0x4B, 0x85, 0xD1), (0xCE, 0x5D, 0x97), (0x3A, 0xA9, 0x9F), (0xEC, 0xEC, 0xE0)
        )
    )

    static let flexokiLight = TerminalTheme(
        id: "flexoki-light",
        name: "Flexoki Light",
        background: UIColor(red: 0xFF, green: 0xFC, blue: 0xF0),
        foreground: UIColor(red: 0x10, green: 0x0F, blue: 0x0F),
        cursor: UIColor(red: 0x10, green: 0x0F, blue: 0x0F),
        selection: UIColor(red: 0xE6, green: 0xE4, blue: 0xD9),
        isDark: false,
        ansiColors: ansi(
            (0xCE, 0xCE, 0xC0), (0xAF, 0x3A, 0x03), (0x66, 0x80, 0x0B), (0xAD, 0x87, 0x01),
            (0x20, 0x5E, 0xA6), (0xA0, 0x2F, 0x6F), (0x24, 0x83, 0x7B), (0x10, 0x0F, 0x0F),
            (0x87, 0x87, 0x80), (0xD1, 0x4D, 0x41), (0x87, 0x9A, 0x39), (0xD0, 0xA2, 0x15),
            (0x4B, 0x85, 0xD1), (0xCE, 0x5D, 0x97), (0x3A, 0xA9, 0x9F), (0x28, 0x28, 0x26)
        )
    )

    // MARK: - Helpers

    /// Build 16 ANSI colors from 8-bit RGB tuples.
    private static func ansi(_ c: (UInt8, UInt8, UInt8)...) -> [SwiftTerm.Color] {
        c.map { SwiftTerm.Color(red: UInt16($0.0) * 257, green: UInt16($0.1) * 257, blue: UInt16($0.2) * 257) }
    }
}

private extension UIColor {
    convenience init(red: UInt8, green: UInt8, blue: UInt8) {
        self.init(
            red: CGFloat(red) / 255,
            green: CGFloat(green) / 255,
            blue: CGFloat(blue) / 255,
            alpha: 1
        )
    }
}
